---
title: 'Lab 1 Question 3: Are survey respondents who have had someone in their home infected by COVID-19 more likely to disapprove of the way their governor is handling the pandemic?'
author: "Yao Chen, Jenny Conde, Satheesh Joseph, Paco Valdez, Yi Zhang"
output: 
  bookdown::pdf_document2: 
    toc: true
---

\clearpage

```{r load packages, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2) 
library(ggcorrplot)
library(haven)

library(tidyverse) 
library(magrittr)
library(knitr)
library(patchwork)
theme_set(theme_bw())
options(tinytex.verbose = TRUE)
```

```{r load and clean data, echo=FALSE, warning=TRUE, message=FALSE}
# Load data
df <- read_dta('data/anes_timeseries_2020_stata_20210211.dta')

# Useful variables
# V201145 -- PRE: APPROVE OR DISAPPROVE R’S GOVERNOR HANDLING COVID-19
  # 1 = approve, 2 = disapprove
gov_approve = 1
gov_disapprove = 2
# V201624 -- PRE: ANYONE IN HOUSEHOLD TESTED POS FOR COVID-19
  # 1 = someone tested positive, 2 = no one tested positive 
pos_test = 1
no_pos_test = 2
# Less useful but still interesting
# V201146 -- PRE: HOW MUCH APPROVE/DISAPPROVE R’S GOVERNOR HANDLING COVID-19
# V201625 -- PRE: ANYONE IN HOUSEHOLD COVID-19 BASED ON SYMPTOMS

df_small <- data.frame(gov=df$V201145, covid=df$V201624)

df_clean <- df_small
df_clean <- df_clean[df_clean$covid > 0,] # remove interview breakoff/refused
df_clean <- df_clean[df_clean$gov > 0,] # remove don't know/refused
```


# Importance and Context
The COVID-19 has changed everything, and one of the most important aspects is how the campaigns for the US 2020 elections were conducted. The pandemic forced to cancel conventions and prompted many states to change how people get and submit their ballots, with all the uncertainty it created. And to make things worse, all of this happened in the middle of social distancing restrictions not seen since almost a century. It's essential to understand how elected officials' approval changed when people got in close contact with COVID-19.

# Description of Data
The ANES data set contains information from 8,280 pre-election interviews with 
U.S. citizens of voting age. Two variables are particularly relevant for us 
to answer this question:

- `V201145`: `APPROVE OR DISAPPROVE R’S GOVERNOR HANDLING COVID-19`

- `V201624`: `ANYONE IN HOUSEHOLD TESTED POS FOR COVID-19`

```{r}
summary(df_clean)
```


```{r, echo = FALSE, fig.cap='Voters\' Approval of Governor and Household COVID-19 Tests', fig.pos='!h'}
df_clean_mod <- mutate(df_clean, gov_approval = ifelse(gov == gov_approve, "Approve", "Disapprove"))
df_clean_mod <- mutate(df_clean_mod, positive_test = ifelse(covid == pos_test, "Positive Test", "No Positive Test"))

gov_count <- df_clean_mod %>%
  group_by(gov_approval) %>%
  summarize(count=n())

pos_test_count <- df_clean_mod %>%
  group_by(positive_test) %>%
  summarize(count = n())

gov_pie_chart <- gov_count %>%
  ggplot() +
  aes(x = "", y = count, fill = gov_approval) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  labs(fill = "Approve or Disapprove of \nGovernor's Response",
       title = "Distribution of Approval of\nGovernor's COVID-19 Handling") +
  theme_void()

covid_pie_chart <- pos_test_count %>%
  ggplot() +
  aes(x = "", y = count, fill = positive_test) + 
  geom_bar(stat = "identity", width = 1) + 
  coord_polar("y", start = 0) +
  labs(fill = "COVID-19 Case in Household",
       title = "Distribution of Households\nwith Positive COVID-19 Tests") +
  theme_void()

(gov_pie_chart) | (covid_pie_chart)
```


```{r, echo = FALSE, fig.pos = '!h'}
summary_table <- prop.table(table(df_clean_mod %>% select(3, 4)))
kable(summary_table,
      digits = 3,
      caption = "Cross Tab of Governor Approval and Positive COVID-19 Tests",
      booktabs = TRUE)
```


```{r, echo = FALSE, fig.pos = '!h'}
```


# Most appropriate test 
First, we notice that the governor approval variable is a Boolean variable. There are only
two valid answers: Approve, or Disapprove. As a result, a parametric test based on some
underlying distribution that resembles Normal would not be appropriate.

At the same time, the groups (people who had a positive test in their household v.s.
people who did not) are distinct people, and they don't have a natural pairing.

Furthermore, given the sampling frame based on a cross-section of registered addresses across 50 states
and the District of Columbia, we feel the data are sufficiently close to be i.i.d.

Based on the above diagnose, the Wilcoxon Rank Sum test is the most appropriate in this case.

# Test, results and interpretation
<!-- What are the results of your test? --> 
<!-- What do the results of this test mean? What is the practical significance? --> 
We establish the *null hypothesis* to be that the average support for the respondent's
governor is the same among people that had a member of the household test positive for COVID-19 and those who did not. 
Given we have no strong initial inclination in either direction, this should be a two tailed test. We use the standard $5\%$ significance level.

``` {r echo=FALSE}
df_clean$approval <- recode(as.character(df_clean$gov), '1' = 'Approve', '2' = 'Disapprove')
df_clean$covid_tested <- recode(as.character(df_clean$covid), '1' = 'Positive', '2' = 'Not positive')
```

First take a look at the table in each of the 4 cases for context, then run the test.
```{r}
table(df_clean$approval, df_clean$covid_tested)
wilcox.test(df_clean$gov ~ df_clean$covid)
```

From the test we can see that the p-value is $0.0377$, which is less than the significance
level $\alpha = 0.05$, meaning that we reject the null hypothesis in favor of the
alternative that people with a positive COVID-19 test in their household have a different
opinion of their Governor than people without.

Practically, we can calculate the correlation between the two variables.

```{r echo=FALSE, fig.cap='Correlation Table for Voters\' Approval of Governor and Household COVID-19 Tests', fig.pos='!h'}
r <- cor(data.frame('Approve' = as.numeric(df_clean_mod$gov==1), 'Disapprove' = as.numeric(df_clean_mod$gov==2), 'Positive' = as.numeric(df_clean_mod$covid==1), 'Not_Positive' = as.numeric(df_clean_mod$covid==2)))
ggcorrplot(r[3:4,1:2], lab = TRUE, ggtheme = ggplot2::theme_dark(), digits = 3)
```

As presented in Fig. 2, having a positive test in the household does linearly 
correlate to less likely to approve the Governor's handling of the pandemic.
However given the magnitude of the the correlation coefficient. The linear relationship isn't
very strong.


